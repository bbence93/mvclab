stages:
  - test
  - deploy

# 1. TESZT: Ennek MINDIG futnia kell (nincs 'rules' szekci√≥)
selenium_test:
  stage: test
  # Olyan image-et haszn√°lunk, amiben m√°r van Chrome, VAGY telep√≠tj√ºk
  image: mcr.microsoft.com/dotnet/sdk:10.0
  variables:
    EDUPORTAL_URL: "http://192.168.1.79:8080"
  before_script:
    # 1. Csomaglist√°k friss√≠t√©se
    - apt-get update
    
    # 2. Csak a let√∂lt√©shez sz√ºks√©ges alap eszk√∂z√∂k (wget)
    - apt-get install -y wget
    
    # 3. Let√∂ltj√ºk a hivatalos Chrome telep√≠t≈ët
    - wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    
    # 4. A VAR√ÅZSLAT: Telep√≠tj√ºk a let√∂lt√∂tt f√°jlt
    # Az 'apt' automatikusan felismeri, hogy mi hi√°nyzik (pl. a libasound2t64), √©s let√∂lti!
    - apt-get install -y ./google-chrome-stable_current_amd64.deb
    
    # 5. Takar√≠t√°s (nem k√∂telez≈ë, de sz√©p)
    - rm google-chrome-stable_current_amd64.deb
  script:
    - echo "üß™ Tesztek futtat√°sa..."
    - dotnet test EduPortal.UITestProject/EduPortal.UITestProject.csproj
  tags:
    - docker

# 2. DEPLOY: Ez csak a MAIN √°gon fut
push_to_github:
  stage: deploy
  image: alpine:latest
  # Ez a sor mondja meg, hogy csak akkor induljon, ha a teszt sikeres volt:
  needs: ["selenium_test"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  before_script:
    - apk add --no-cache git
  script:
    - echo "üöÄ K√≥d k√ºld√©se a GitHubra..."
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/bbence93/mvclab.git
    - git push --force github HEAD:main
  tags:
    - docker
